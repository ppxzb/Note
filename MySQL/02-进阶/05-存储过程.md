## 一、特点

```text
封装，复用
```

```text
可以接收参数，也可以返回数据
```

```text
减少网络交互，效率提升
```

## 二、基本语法

### 1. 创建

```sql
CREATE PROCEDURE 存储过程名称([参数列表])
BEGIN
  -- SQL语句
END;
```

> 注意：在命令行中执行时，需通过 `delimiter` 来设置 SQL 语句的结束符号。  

### 2. 调用

```sql
CALL 名称([参数]);
```

### 3. 查看

- 指定数据库的存储过程及状态信息
```sql
SELECT * FROM INFORMATION_SCHEMA.ROUTINES
WHERE ROUTINE_SCHEMA = 'XXX';
```

- 查看某个存储过程的定义
```sql
SHOW CREATE PROCEDURE 存储过程名称;
```

### 4. 删除

```sql
DROP PROCEDURE [IF EXISTS] 存储过程名称;
```

## 三、变量

### 1. 系统变量

#### 系统变量类型

```text
全局变量（GLOBAL）
```

```text
会话变量（SESSION）
```

#### 语法

- 查看系统变量
  - 查看所有系统变量
  ```sql
  SHOW [SESSION | GLOBAL] VARIABLES;
  ```
  - 通过 LIKE 模糊匹配方式查找变量
  ```sql
  SHOW [SESSION | GLOBAL] VARIABLES LIKE '......';
  ```
  - 查看指定变量的值
  ```sql
  SELECT @@[SESSION | GLOBAL] 系统变量名;
  ```

- 设置系统变量
```sql
SET [SESSION | GLOBAL] 系统变量名;
SET @@[SESSION | GLOBAL] 系统变量名;
```

### 2. 用户自定义变量

#### 赋值

- `SET` 赋值
```sql
SET @var_name = expr [,@var_name = expr]...;
SET @var_name := expr [,@var_name = expr]...;
```

- `SELECT` 赋值
```sql
SELECT @var_name := expr [,@var_name := expr]...;
SELECT 字段名 INTO @var_name FROM 表名;
```

#### 使用

```sql
SELECT @var_name;
```

### 3. 局部变量

#### 声明

```sql
DECLARE 变量名 变量类型 [DEFAULT ...];
```

> 变量类型：INT、BIGINT、CHAR、VARCHAR、DATE、TIME 等  
> DEFAULT：默认值  

#### 赋值

- `SET` 赋值
```sql
SET 变量名 = 值;
SET 变量名 := 值;
```

- `SELECT` 赋值
```sql
SELECT 字段名 INTO 变量名 FROM 表名 ...;
```

## 四、参数

### 1. 参数类型

```text
IN
OUT
INOUT
```

### 2. 语法

```sql
CREATE PROCEDURE 存储过程名称(
  (IN/OUT/INOUT 参数名 参数类型)
)
BEGIN
  SQL语句
END;
```

## 五、IF 判断

```sql
IF 条件1 THEN
  ...
ELSEIF 条件2 THEN
  ...
ELSE
  ...
END IF;
```

## 六、CASE

```sql
CASE case_value
  WHEN when_value1 THEN statement_list1
  [WHEN when_value2 THEN statement_list2]
  ...
  [ELSE statement_list]
END CASE;

CASE
  WHEN search_condition1 THEN statement_list1
  [WHEN search_condition2 THEN statement_list2]
  ...
  [ELSE statement_list]
END CASE;
```

## 七、循环

### 1. WHILE

```sql
WHILE 条件 DO
  SQL逻辑...
END WHILE;
```

### 2. REPEAT

```sql
REPEAT
  SQL逻辑...
UNTIL 条件
END REPEAT;
```

### 3. LOOP

```sql
[begin_label:] LOOP
  SQL逻辑...
END LOOP [end_label];
```

- `LEAVE label`：退出指定标记的循环  
- `ITERATE label`：直接进入下一次循环  

## 八、游标（cursor）

```sql
DECLARE 游标名称 CURSOR FOR 查询语句;
OPEN 游标名称;
FETCH 游标名称 INTO 变量[,变量];
CLOSE 游标名称;
```

## 九、条件处理程序（handler）

```sql
DECLARE handler_action HANDLER
FOR condition_value [, condition_value]...
statement;
```

- `handler_action`
  - `CONTINUE`：继续执行当前程序  
  - `EXIT`：终止执行当前程序  

- `condition_value`
  - `SQLSTATE sqlstate_value`：状态码  
  - `SQLWARNING`：所有以 01 开头的 SQLSTATE 代码的简写  
  - `NOT FOUND`：所有以 02 开头的 SQLSTATE 代码的简写  
  - `SQLEXCEPTION`：所有没有被 SQLWARNING 或 NOT FOUND 捕获的 SQLSTATE 代码的简写
